<html>
  <head>
    <title>Item Maintenance</title>
    <link rel="stylesheet" type="text/css" href="./customer.css">
    <script src="https://s3.amazonaws.com/stitch-sdks/js/bundles/4.5.0/stitch.js"></script>
    <script src="https://unpkg.com/@mongodb-js/charts-embed-dom@next"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script>
        const sdk = new ChartsEmbedSDK;
        const client = stitch.Stitch.initializeDefaultAppClient('inventory-rccnj');
        const db = client.getServiceClient(stitch.RemoteMongoClient.factory,
        "mongodb-atlas").db('InventoryDemo');

        function displayItemsOnLoad() {
          client.auth
            .loginWithCredential(new stitch.AnonymousCredential())
            .then(displayItems)
            .then(showCompany)
            .catch(console.error);
        }

        function editItem( aPartition, aItemId, aName, aPrice, aQuantity, aMinQuantity, aSupplier){
            document.getElementById("partition").value = aPartition;
            document.getElementById("itemId").value = aItemId;
            document.getElementById("name").value = aName;
            document.getElementById("price").value = aPrice;
            document.getElementById("quantity").value = aQuantity;
            document.getElementById("mQuantity").value = aMinQuantity;
            document.getElementById("supplier").value = aSupplier;
        }
        function displayItems() {
          var searchDoc = {};
          var vPartition = document.getElementById('sPartition');
          var vName = document.getElementById('sName');
          var vPrice = document.getElementById('sPrice');
          var vQuantity = document.getElementById('sQuantity');
          if ( vPartition.value != "") {
          searchDoc["_partition"] =  vPartition.value;
          }
          if ( vName.value != "") {
          searchDoc["name"] = { $regex: new RegExp(vName.value) };
          }
          if ( vPrice.value != "") {
          searchDoc["price"] = parseFloat(vPrice.value);
          }
          if ( vQuantity.value != "") {
          searchDoc["quantity"] = parseInt(vQuantity.value);
          }
          console.log("Search doc: "+ JSON.stringify(searchDoc));
              var theader = "<th>Store ID</th><th>_id</th><th>Name</th><th>Price</th><th>Quantity</th><th>Min Quantity</th><th>Supplier</th><th>Edit</th>";
              db.collection('InventoryItem').find(searchDoc,{limit: 100}).asArray()
                .then(docs => {
                  var thtml = "";
                  var project = "";
                  docs.map(c => {
                    if (c) {
                          thtml = thtml + "<tr>" +
                          "<td>" + c._partition + "</td>" +
                          "<td>" + c._id + "</td>" +
                          "<td>" + c.name + "</td>" +
                          "<td>" + c.price + "</td>" +
                          "<td>" + c.quantity + "</td>" +
                          "<td>" + c.min_quantity + "</td>" +
                          "<td>" + c.supplier + "</td>" +
                          "<td>" +
                            "<button type=\"checkbox\" class=\"blueTable\"" +
                            "onClick=\"editItem(" +
                                "\'"+ c._partition + "\'," +
                                "\'"+ c._id + "\'," +
                                "\'"+ c.name + "\'," +
                                "\'"+ c.price + "\'," +
                                "\'"+ c.quantity + "\'," +
                                "\'"+ c.min_quantity + "\'," +
                                "\'"+ c.supplier + "\'" +
                            ")\">" +
                            "<i class=\"material-icons\" style=\"font-size:18px\">" +
                            "mode_edit</i></button>" +
                            "</td>" +
                          "</tr>";
                    }
                  });

                  //var version = docs.map(c => c.__stitch_sync_version.v).join("");
                  //var taskVersion = task + ", version: " + version + "<br>";
                  document.getElementById("items").innerHTML = "<div><table class=\"blueTable\">" + theader + thtml + "</table></div>";
                  document.getElementById("user").innerHTML = "Stitch User: " + client.auth.user.id;

                });
       }
       async function showCompany(){
            db.collection('codes').find({"CODE_TYPE":"COMPANY_NAME"},{limit: 100}).asArray()
              .then(docs => {
                var cCompanyName = "";
                docs.map(c => {
                  if (c) {
                      cCompanyName = c.VALUE;
                  }
                });
                document.getElementById("companyName").value = cCompanyName;
            });
            db.collection('codes').find({"CODE_TYPE":"COMPANY_LOGO"},{limit: 100}).asArray()
            .then(docs => {
              var cCompanyLogo = "";
              docs.map(c => {
                if (c) {
                  cCompanyLogo = c.VALUE;
                }
              });
              document.getElementById("companyLogo").value = cCompanyLogo;
              var logoHtml = "<img src=\""+ cCompanyLogo + "\">";
              document.getElementById("displayLogo").innerHTML = logoHtml;
            });
        }
        async function updateCompany() {
            var vCompanyName = document.getElementById('companyName').value;
            var vCompanyLogo = document.getElementById('companyLogo').value;
            var result1 = await db.collection('codes').updateOne(
  	        { "CODE_TYPE":  "COMPANY_NAME"},
  	        { $set: {   "VALUE": vCompanyName, } },
                {upsert: true}
            );
            console.log("result1: " + JSON.stringify(result1));
            var result2 = await db.collection('codes').updateOne(
  	        { "CODE_TYPE":  "COMPANY_LOGO"},
  	        { $set: {   "VALUE": vCompanyLogo, } },
                {upsert: true}
            );
            console.log("result2: " + JSON.stringify(result1));
            showCompany();
        }
        async function updateItem() {
            var vPartition = document.getElementById('partition').value;
            var vItemId = new stitch.BSON.ObjectId(document.getElementById('itemId').value);
            var vName = document.getElementById('name').value;
            var vPrice = parseFloat(document.getElementById('price').value);
            var vQuantity = parseInt(document.getElementById('quantity').value);
            var vMinQuantity = parseInt(document.getElementById('mQuantity').value);
            var vSupplier = document.getElementById('supplier').value;
            var result1 = await db.collection('InventoryItem').updateOne(
  	        { _id:  vItemId},
  	        { $set: {   "name": vName, 
                        "_partition": vPartition, 
                        "price": vPrice, 
                        "quantity": vQuantity,
                        "min_quantity": vMinQuantity,
                        "supplier": vSupplier	}
                },
                {upsert: true}
            );
            console.log("result1: " + JSON.stringify(result1));
            displayItems();
        }
        function showCharts(){
          var ck = document.getElementById('showCharts').checked;
          //alert(ck);
          if(ck){
            const chart = sdk
              .createChart({
                baseUrl: 'https://charts.mongodb.com/charts-britton-fpgad',
                chartId: '93810a80-8cc3-4d65-bb8a-58bc31e1bb10',
                width: 800,
                height: 400,
                refreshInterval: 60
              })
              .render(document.getElementById('chart1'));
            const chart2 = sdk
              .createChart({
                baseUrl: 'https://charts.mongodb.com/charts-britton-fpgad',
                chartId: 'ad354307-ba02-4bc5-82db-60a2dc63242b',
                width: 800,
                height: 400,
                refreshInterval: 60
              })
              .render(document.getElementById('chart2'));
          } else {
            document.getElementById("chart1").innerHTML = "";
            document.getElementById("chart2").innerHTML = "";
          }
        }
        var myVar = setInterval(myTimer, 3000);

        function myTimer() {
            if (document.getElementById('autoRef').checked){
                var d = new Date();
                document.getElementById("lastUpdate").value = d.toLocaleTimeString();
                displayItems();
            }
        }

    </script>

    </head>
  <body onload="displayItemsOnLoad()">
	<table>
	<tr>
	<td>
		<div id="contact" class="container">
      <h3>Item Search</h3>
      <div id=displayLogo></div>
		  <p id="user"></p>
          <fieldset><input type="text" placeholder="Store Id:" id="sPartition"></fieldset>
          <fieldset><input type="text" placeholder="Item Id:" id="sItemId"></fieldset>
		  <fieldset><input type="text" placeholder="Item Name:" id="sName"></fieldset>
		  <fieldset><input type="text" placeholder="Price:" id="sPrice"></fieldset>
          <fieldset><input type="text" placeholder="Quantity:" id="sQuantity"></fieldset>
          <fieldset>
            <label for="autoRef"> Auto Refresh</label>
            <input type="checkbox" id="autoRef" name="autoRef">
            <br>
            <label for="showCharts"> Show Charts</label>
            <input type="checkbox" id="showCharts" name="showCharts" onClick="showCharts()">
            <input type="text" placeholder="Last Update:" id="lastUpdate"></fieldset>
		  <button type="submit" id="refresh" onClick="displayItems()">Search</button>
		 </div>
	</td>
	<td>...</td>
	<td>
    <div id="contact" class="container">
      <h1>Back office Administration (Realm Hosted)</h1>
      <div id="chart1"></div>
      <div id="chart2"></div>
      <fieldset><input type="text" placeholder="Company Name:" id="companyName"></fieldset>
      <fieldset><input type="text" placeholder="Company Logo:" id="companyLogo"></fieldset>
      <button type="submit" id="contact-submit" onClick="updateCompany()">Update Company</button>
    </div>
		<div id="contact" class="container">
		  <h3>Item Maintenance</h3>
		  <fieldset><input type="text" placeholder="Store Id:" id="partition"></fieldset>
		  <fieldset><input type="text" placeholder="Item Id:" id="itemId"></fieldset>
		  <fieldset><input type="text" placeholder="Name:" id="name"></fieldset>
		  <fieldset><input type="text" placeholder="Price:" id="price"></fieldset>
          <fieldset><input type="text" placeholder="Quantity:" id="quantity"></fieldset>
          <fieldset><input type="text" placeholder="Min Quantity:" id="mQuantity"></fieldset>
          <fieldset><input type="text" placeholder="Supplier:" id="supplier"></fieldset>
		  <hr>
		  <button type="submit" id="contact-submit" onClick="updateItem()">Update Item</button>
    </div>

		<div id="contact" class= container>
		<hr>
			<button type="submit" id="refresh" onClick="displayItems()">Refresh Display</button>
		<hr>
		<div id="items">Loading...<br><img src="loading.gif"></div>
    </div>

	</td>
	</tr>
	</table>
  </body>

</html>