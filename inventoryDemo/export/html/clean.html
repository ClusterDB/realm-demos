<html>
  <head>
    <title>Item Maintenance</title>
    <link rel="stylesheet" type="text/css" href="./customer.css">
    <script src="https://s3.amazonaws.com/stitch-sdks/js/bundles/4.5.0/stitch.js"></script>
    <script src="https://unpkg.com/@mongodb-js/charts-embed-dom@next"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script>
        const sdk = new ChartsEmbedSDK;
        const client = stitch.Stitch.initializeDefaultAppClient('inventory-rccnj');
        const db = client.getServiceClient(stitch.RemoteMongoClient.factory,
        "mongodb-atlas").db('InventoryDemo');

        function displayItemsOnLoad() {
          client.auth
            .loginWithCredential(new stitch.AnonymousCredential())
            .then(displayItems)
            .then(showCompany)
            .catch(console.error);
        }

        function editItem( aPartition, aItemId, aName, aPrice, aQuantity, aMinQuantity, aSupplier){
            console.log("edit item: nothing to do");
        }
        function displayItems() {
              var theader = "<th>Store ID</th><th>_id</th><th>Name</th><th>Price</th><th>Quantity</th><th>Min Quantity</th><th>Supplier</th><th>Edit</th>";
              db.collection('InventoryItem').find({},{limit: 100}).asArray()
                .then(docs => {
                  var thtml = "";
                  var project = "";
                  docs.map(c => {
                    if (c) {
                          thtml = thtml + "<tr>" +
                          "<td>" + c._partition + "</td>" +
                          "<td>" + c._id + "</td>" +
                          "<td>" + c.name + "</td>" +
                          "<td>" + c.price + "</td>" +
                          "<td>" + c.quantity + "</td>" +
                          "<td>" + c.min_quantity + "</td>" +
                          "<td>" + c.supplier + "</td>" +
                          "<td>" +
                            "<button type=\"checkbox\" class=\"blueTable\"" +
                            "onClick=\"editItem(" +
                                "\'"+ c._partition + "\'," +
                                "\'"+ c._id + "\'," +
                                "\'"+ c.name + "\'," +
                                "\'"+ c.price + "\'," +
                                "\'"+ c.quantity + "\'," +
                                "\'"+ c.min_quantity + "\'," +
                                "\'"+ c.supplier + "\'" +
                            ")\">" +
                            "<i class=\"material-icons\" style=\"font-size:18px\">" +
                            "mode_edit</i></button>" +
                            "</td>" +
                          "</tr>";
                    }
                  });

                  //var version = docs.map(c => c.__stitch_sync_version.v).join("");
                  //var taskVersion = task + ", version: " + version + "<br>";
                  document.getElementById("items").innerHTML = "<div><table class=\"blueTable\">" + theader + thtml + "</table></div>";

                });
       }
       async function showCompany(){
            db.collection('codes').find({"CODE_TYPE":"COMPANY_NAME"},{limit: 100}).asArray()
              .then(docs => {
                var cCompanyName = "";
                docs.map(c => {
                  if (c) {
                      cCompanyName = c.VALUE;
                  }
                });
                document.getElementById("companyName").value = cCompanyName;
            });
            db.collection('codes').find({"CODE_TYPE":"COMPANY_LOGO"},{limit: 100}).asArray()
            .then(docs => {
              var cCompanyLogo = "";
              docs.map(c => {
                if (c) {
                  cCompanyLogo = c.VALUE;
                }
              });
              document.getElementById("companyLogo").value = cCompanyLogo;
              var logoHtml = "<img src=\""+ cCompanyLogo + "\">";
              document.getElementById("displayLogo").innerHTML = logoHtml;
            });
        }
        async function updateCompany() {
            var vCompanyName = document.getElementById('companyName').value;
            var vCompanyLogo = document.getElementById('companyLogo').value;
            var result1 = await db.collection('codes').updateOne(
  	        { "CODE_TYPE":  "COMPANY_NAME"},
  	        { $set: {   "VALUE": vCompanyName, } },
                {upsert: true}
            );
            console.log("result1: " + JSON.stringify(result1));
            var result2 = await db.collection('codes').updateOne(
  	        { "CODE_TYPE":  "COMPANY_LOGO"},
  	        { $set: {   "VALUE": vCompanyLogo, } },
                {upsert: true}
            );
            console.log("result2: " + JSON.stringify(result1));
            showCompany();
        }
        function resetResults(){
            document.getElementById("dbResult1").value = "";
            document.getElementById("dbResult2").value = "";
            document.getElementById("dbResult3").value = "";
        }
        async function deleteInventoryTransactions() {
            resetResults();
            var result1 = await db.collection('transactions').deleteMany({});
            console.log("transactions: " + JSON.stringify(result1));
            document.getElementById("dbResult1").value = "transactions: " +JSON.stringify(result1);
            var result2 = await db.collection('transaction_hist').deleteMany({});
            document.getElementById("dbResult2").value = "transaction_hist:" + JSON.stringify(result2);
            console.log("result2: " + JSON.stringify(result2));
            var result3 = await db.collection('kafka_sink').deleteMany({});
            document.getElementById("dbResult3").value = "kafka_sink: " + JSON.stringify(result3);
            console.log("result3: " + JSON.stringify(result3));
            displayItems();
        }
        async function deleteInventoryItems() {
            resetResults();
            var result1 = await db.collection('InventoryItem').deleteMany({});
            console.log("result1: " + JSON.stringify(result1));
            document.getElementById("dbResult1").value = "InventoryItem: " + JSON.stringify(result1);
            displayItems();
        }
        async function deleteSales() {
            resetResults();
            var result1 = await db.collection('sales').deleteMany({});
            console.log("result1: " + JSON.stringify(result1));
            document.getElementById("dbResult1").value = "sales: " + JSON.stringify(result1);
            displayItems();
        }
        async function deleteInventoryHistory() {
            resetResults()
            var result1 = await db.collection('inventory_hist').deleteMany({});
            console.log("result1: " + JSON.stringify(result1));
            document.getElementById("dbResult1").value = "inventory_hist" + JSON.stringify(result1);
            var result2 = await db.collection('inventory_last').deleteMany({});
            console.log("result1: " + JSON.stringify(result2));
            document.getElementById("dbResult2").value = "inventory_last: " + JSON.stringify(result2);
            displayItems();
        }

    </script>

    </head>
  <body onload="displayItemsOnLoad()">
	<table>
	<tr>
	<td>
    <div id="contact" class="container">
      <h3>Clean Demo Data</h3>
      <div id=displayLogo></div>
	</div>
	</td>
	<td>...</td>
	<td>
    <div id="contact" class="container">
      <h1>Back office Administration (Realm Hosted)</h1>
      <div id="chart1"></div>
      <div id="chart2"></div>
      <fieldset><input type="text" placeholder="Company Name:" id="companyName"></fieldset>
      <fieldset><input type="text" placeholder="Company Logo:" id="companyLogo"></fieldset>
      <button type="submit" id="contact-submit" onClick="updateCompany()">Update Company</button>
    </div>
		<div id="contact" class="container">
          <h3>Remove Data</h3>
          <button type="submit" id="contact-submit" onClick="deleteInventoryItems()">Delete Inventory Items</button>
          <fieldset><input type="text" placeholder="Results 1:" id="dbResult1"></fieldset>
          <fieldset><input type="text" placeholder="Results 2:" id="dbResult2"></fieldset>
          <fieldset><input type="text" placeholder="Results 3:" id="dbResult3"></fieldset>
          <button type="submit" id="contact-submit" onClick="deleteInventoryTransactions()">Delete Transactions</button>
          <button type="submit" id="contact-submit" onClick="deleteInventoryHistory()">Delete Inventory History</button>
          <button type="submit" id="contact-submit" onClick="deleteSales()">Delete Sales</button>
    </div>

		<div id="contact" class= container>
		<hr>
			<button type="submit" id="refresh" onClick="displayItems()">Refresh Display</button>
		<hr>
		<div id="items">Loading...<br><img src="loading.gif"></div>
    </div>

	</td>
	</tr>
	</table>
  </body>

</html>