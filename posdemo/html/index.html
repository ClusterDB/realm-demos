<html>
  <head>
    <title>Item Maintenance</title>
    <link rel="stylesheet" type="text/css" href="./customer.css">
    <script src="https://s3.amazonaws.com/stitch-sdks/js/bundles/4.5.0/stitch.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script>
        const client = stitch.Stitch.initializeDefaultAppClient('posdemo-jzbvq');
        const db = client.getServiceClient(stitch.RemoteMongoClient.factory,
        "mongodb-atlas").db('posdemo');

        function displayItemsOnLoad() {
          client.auth
            .loginWithCredential(new stitch.AnonymousCredential())
            .then(displayItems)
            .catch(console.error);
        }

        function editItem( aProjectID, aItemId, aItemDesc, aPrice, aQuantity, aOnSale, aTimeStamp){
            document.getElementById("projectId").value = aProjectID;
            document.getElementById("itemId").value = aItemId; 
            document.getElementById("price").value = aPrice; 
            document.getElementById("quantity").value = aQuantity; 
            document.getElementById("itemDesc").value = aItemDesc;
            document.getElementById("onSale").value = aOnSale; 
        }
        function displayItems() {
          var theader = "<th>Project</th><th>id</th><th>Item</th><th>Price</th><th>Quantity</th><th>On Sale</th><th>Timestamp</th><th>Edit</th>";
          db.collection('projects').find({},{limit: 100}).asArray()
            .then(docs => {
              var thtml = "";
              var project = "";
              docs.map(c => {
                if (c.items) {
                  if (Array.isArray(c.items)) {
                    project = c._id;
                    c.items.forEach( function(myDoc) {
                      thtml = thtml + "<tr><td>" + project + "</td>" +
                      "<td>" + myDoc._id + "</td>" +
                      "<td>" + myDoc.body+ "</td>" +  
                      "<td>" + myDoc.price+ "</td>" + 
                      "<td>" + myDoc.quantity+ "</td>" + 
                      "<td>" + myDoc.isDone + "</td>" + 
                      "<td>" + myDoc.timestamp + "</td>" +
                      "<td> " + 
                        "<button type=\"checkbox\" class=\"blueTable\"" +
                        "onClick=\"editItem(" + 
                            "\'"+ project + "\'," +
                            "\'"+ myDoc._id + "\'," +
                            "\'"+ myDoc.body + "\'," +
                            "\'"+ myDoc.price + "\'," +
                            "\'"+ myDoc.quantity + "\'," +
                            "\'"+ myDoc.isDone + "\'," +
                            "\'"+ myDoc.timestamp + "\'" +
                        ")\">" +
                        "<i class=\"material-icons\" style=\"font-size:18px\">" +
                        "mode_edit</i></button>" + 
                        "</td>" +
                      "</tr>";
                    });
                  }
                  
                }
              });
              
              //var version = docs.map(c => c.__stitch_sync_version.v).join("");
              //var taskVersion = task + ", version: " + version + "<br>";
              document.getElementById("items").innerHTML = "<div><table class=\"blueTable\">" + theader + thtml + "</table></div>";
              document.getElementById("user").innerHTML = "Stitch User: " + client.auth.user.id;

            });
        }

        async function updateItem() {
            var vProjectId = document.getElementById('projectId').value;
            var vItemId = document.getElementById('itemId').value;
            var vItemDesc = document.getElementById('itemDesc').value;
            var vPrice = document.getElementById('price').value;
            var vQuantity = document.getElementById('quantity').value;
            var vOnSale = document.getElementById('onSale').checked;
            
            var result1 = await db.collection('projects').updateOne(
  	        { _id:  vProjectId},
  	        { $pull: { "items": { _id: vItemId } }	}
            );
            console.log("result1: " + JSON.stringify(result1));
            alert("Removed previous item, setting on sale: " + vOnSale);
            var result2 = await client.callFunction("fncUpdateItem", [vProjectId,vItemId,vItemDesc, vPrice, vQuantity, vOnSale]);
            console.log("result2: " + JSON.stringify(result2));
            displayItems();
        }

    </script>

    </head>
  <body onload="displayItemsOnLoad()">
    <div class="container">
        <h1>Back office Administration (Stitch Hosted)</h1>
    </div>
    <div id="contact" class="container">
      <h3>Item Maintenance</h3>
      <img src="logo.png">
      <p id="user"></p>
      <fieldset><input type="text" placeholder="Store Id:" id="projectId"></fieldset>
      <fieldset><input type="text" placeholder="Item Id:" id="itemId"></fieldset>
      <fieldset><input type="text" placeholder="Item Name:" id="itemDesc"></fieldset>
      <fieldset><input type="text" placeholder="Price:" id="price"></fieldset>
      <fieldset><input type="text" placeholder="Quantity:" id="quantity"></fieldset>
      <fieldset>On Sale:<input type="checkbox" id="onSale"></fieldset>
      <hr>
      <button type="submit" id="contact-submit" onClick="updateItem()">Upsert Item</button>
    </div>
    <div id="contact" class= container>
	<hr>
  
        <button type="submit" id="refresh" onClick="displayItems()">Refresh Display</button>
      
    <hr>

    <div id="items"></div>
    </div>

  </body>

</html>